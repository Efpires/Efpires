SELECT DISTINCT REPLACE(h.name, 'Firewall ', '') AS name,
  hi.location_lat AS lat, hi.location_lon AS lon,
  CASE
    WHEN t.value = 1 THEN 1
    WHEN MAX(CASE WHEN t_link.value = 1 THEN 1 ELSE 0 END) = 1 THEN 2
    ELSE 0
  END AS status,
  hi.notes AS Notas
FROM triggers t
INNER JOIN functions f ON t.triggerid = f.triggerid
INNER JOIN items i ON f.itemid = i.itemid
INNER JOIN hosts h ON i.hostid = h.hostid
INNER JOIN hosts_groups hg ON h.hostid = hg.hostid
INNER JOIN hstgrp g ON hg.groupid = g.groupid
INNER JOIN host_inventory hi ON h.hostid = hi.hostid
LEFT JOIN (
  SELECT i2.hostid, t2.value
  FROM triggers t2
  INNER JOIN functions f2 ON t2.triggerid = f2.triggerid
  INNER JOIN items i2 ON f2.itemid = i2.itemid
  WHERE t2.description ILIKE '%inoperante'
) t_link ON t_link.hostid = h.hostid
WHERE g.name LIKE 'Protege/Seguranca/Firewall/%'
  AND t.description ILIKE '%Base%'
  AND h.name NOT ILIKE ANY (ARRAY['%AWS ProtegeCash%','%Datacenter%','%Nova Campinas%','%Sao Sebastiao%'])
GROUP BY h.name, hi.location_lat, hi.location_lon, t.value, hi.notes;

=============================================

SELECT DISTINCT REPLACE(h.name, 'Firewall ', '') AS name,
  hi.location_lat AS lat, hi.location_lon AS lon,
  t.value AS status, hi.notes AS Notas
FROM triggers t
INNER JOIN functions f ON t.triggerid = f.triggerid
INNER JOIN items i ON f.itemid = i.itemid
INNER JOIN hosts h ON i.hostid = h.hostid
INNER JOIN hosts_groups hg ON h.hostid = hg.hostid
INNER JOIN hstgrp g ON hg.groupid = g.groupid
INNER JOIN host_inventory hi ON h.hostid = hi.hostid
WHERE g.name LIKE 'Protege/Seguranca/Firewall/%'
  AND t.description ILIKE '%Base%'
  AND h.name NOT ILIKE ANY (ARRAY['%AWS ProtegeCash%','%Datacenter%','%Nova Campinas%','%Sao Sebastiao%']);
