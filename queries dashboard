SELECT 
  h.name AS mpls,
  ROUND(100 - (AVG(CASE WHEN t.value_avg = 1 THEN 100 ELSE 0 END)), 2) AS indisponibilidade,
  ROUND(AVG(CASE WHEN t.value_avg = 1 THEN 100 ELSE 0 END), 2) AS disponibilidade
FROM hosts h
INNER JOIN items i ON h.hostid = i.hostid
INNER JOIN trends t ON i.itemid = t.itemid
INNER JOIN hosts_groups hg ON h.hostid = hg.hostid
INNER JOIN hstgrp g ON hg.groupid = g.groupid
WHERE 
  i.key_ = 'icmpping'
  AND h.status = 0
  AND g.name = 'Protege/MPLS/Monitoramento'
  AND t.clock BETWEEN EXTRACT(EPOCH FROM $__timeFrom())::bigint 
                  AND EXTRACT(EPOCH FROM $__timeTo())::bigint
GROUP BY h.name
ORDER BY indisponibilidade DESC
LIMIT 10;
