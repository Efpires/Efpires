SELECT 
  ht.name AS host,
  MAX(h.value) AS usecpu
FROM items it
INNER JOIN hosts ht ON ht.hostid = it.hostid
INNER JOIN hosts_groups hg ON hg.hostid = ht.hostid
INNER JOIN hstgrp g ON g.groupid = hg.groupid
LEFT JOIN history h ON it.itemid = h.itemid AND h.clock > EXTRACT(EPOCH FROM NOW()) - 1800
WHERE g.name = $base
  AND it.key_ LIKE '%cpu utilization%'
GROUP BY ht.name
ORDER BY ht.name;
